<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Suggero no trads</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="templates/styles.css" />
  <link rel="stylesheet" href="templates/login.css" />
  <link rel="stylesheet" href="templates/pages.css" />
</head>
<body>

  <div id="app-container"></div>

  <!-- Contenedor del widget -->
  <div id="chat-widget"></div>

  <!-- Bundle IIFE -->
  <script src="/dist/chat-widget.standalone.iife.js"></script>

  <script type="module">
    // Cargar templates
    async function loadTemplates() {
      try {
        const loginHtml = await fetch('templates/login.html').then(r => r.text());
        const page1Html = await fetch('templates/page1.html').then(r => r.text());
        const page2Html = await fetch('templates/page2.html').then(r => r.text());
        
        document.getElementById('app-container').innerHTML = loginHtml + page1Html + page2Html;
        
        initializeApp();
      } catch (error) {
        console.error('Error loading templates:', error);
      }
    }

    function initializeApp() {
      // Función de navegación entre páginas
      window.goToPage = function(pageId) {
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');
        updateAllUserInfo();
      }

      // Función de login
      window.handleLogin = function(event) {
        event.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorMessage = document.getElementById('errorMessage');

        if (email === 'ivan.izquierdo@asm.com' && password === 'prueba123') {
          localStorage.setItem('user', JSON.stringify({ email, name: 'Iván' }));
          
          document.getElementById('email').value = '';
          document.getElementById('password').value = '';
          errorMessage.classList.remove('show');

          updateAllUserInfo();
          initChatWidget();
          goToPage('page1');
          location.reload(); 
        } else {
          errorMessage.textContent = translations[currentLanguage].errorLogin;
          errorMessage.classList.add('show');
        }
      }

      // Función de logout
      window.handleLogout = function() {
        localStorage.removeItem('user');
        updateAllUserInfo();
        goToPage('loginPage');
        location.reload();
      }

      // Actualizar información del usuario
      function updateAllUserInfo() {
        const user = localStorage.getItem('user');

        if (user) {
          const userData = JSON.parse(user);

          const el1 = document.getElementById('userName');
          const el2 = document.getElementById('userName2');
          const box1 = document.getElementById('userInfoBox');
          const box2 = document.getElementById('userInfoBox2');
          const btn1 = document.getElementById('loginBtnPage1');
          const btn2 = document.getElementById('loginBtnPage2');

          if (el1) el1.textContent = userData.name;
          if (el2) el2.textContent = userData.name;
          if (box1) box1.classList.remove('hidden');
          if (box2) box2.classList.remove('hidden');
          if (btn1) btn1.style.display = 'none';
          if (btn2) btn2.style.display = 'none';
        } else {
          const box1 = document.getElementById('userInfoBox');
          const box2 = document.getElementById('userInfoBox2');
          const btn1 = document.getElementById('loginBtnPage1');
          const btn2 = document.getElementById('loginBtnPage2');

          if (box1) box1.classList.add('hidden');
          if (box2) box2.classList.add('hidden');
          if (btn1) btn1.style.display = 'inline-block';
          if (btn2) btn2.style.display = 'inline-block';
        }
      }

      // Inicializar el widget usando IIFE
      function initChatWidget() {
        const user = JSON.parse(localStorage.getItem('user'));
        const userName = user?.name;

        window.CHAT_WIDGET_CONFIG = { userName };

        ChatWidget.init({
          target: '#chat-widget',
          styleApiUrl: 'https://assistant.suggero.io/chatbot-feature/1',
          project: 'dyv',
          backend: 'https://assistant.suggero.io'
        });
      }

      updateAllUserInfo();
      initChatWidget();

      const user = localStorage.getItem('user');
      if (user) {
        goToPage('page1');
      }
    }

    loadTemplates();
  </script>
</body>
</html>