<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat Widget - Con Estilos desde API</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="templates/styles.css" />
  <link rel="stylesheet" href="templates/login.css" />
  <link rel="stylesheet" href="templates/pages.css" />
</head>
<body>
  <div id="app-container"></div>

  <script type="module">
    import { init } from '/src/mount.js'

    // Cargar templates
    async function loadTemplates() {
      try {
        const loginHtml = await fetch('templates/login.html').then(r => r.text());
        const page1Html = await fetch('templates/page1.html').then(r => r.text());
        const page2Html = await fetch('templates/page2.html').then(r => r.text());
        
        document.getElementById('app-container').innerHTML = loginHtml + page1Html + page2Html;
        
        // Inicializar después de cargar templates
        initializeApp();
      } catch (error) {
        console.error('Error loading templates:', error);
      }
    }

    function initializeApp() {
      function initChatWidget() {
        const user = JSON.parse(localStorage.getItem('user'));
        const userName = user?.name;

        window.CHAT_WIDGET_CONFIG = { userName };

        init({
          styleApiUrl: 'http://localhost:3000/chatbot-feature/4',
          backend: 'http://localhost:3000',
        })
      }

      // Función de navegación entre páginas
      window.goToPage = function(pageId) {
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');
        
        // Limpiar y actualizar info del usuario en ambas páginas
        updateAllUserInfo();
      }

      // Función de login
      window.handleLogin = function(event) {
        event.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorMessage = document.getElementById('errorMessage');

        if (email === 'ivan.izquierdo@asm.com' && password === 'prueba123') {
          localStorage.setItem('user', JSON.stringify({ email, name: 'Iván' }));
          
          document.getElementById('email').value = '';
          document.getElementById('password').value = '';
          errorMessage.classList.remove('show');

          updateAllUserInfo();
          initChatWidget();
          goToPage('page1');
        } else {
          errorMessage.textContent = 'Email o contraseña incorrectos';
          errorMessage.classList.add('show');
        }
      }

      // Función de logout
      window.handleLogout = function() {
        localStorage.removeItem('user');
        updateAllUserInfo();
        goToPage('loginPage');
        location.reload(); // Recarga la página para reiniciar el widget
      }

      // Actualizar información del usuario en todas las páginas
      function updateAllUserInfo() {
        const user = localStorage.getItem('user');
        
        if (user) {
          const userData = JSON.parse(user);
          document.getElementById('userName').textContent = userData.name;
          document.getElementById('userName2').textContent = userData.name;
          document.getElementById('userInfoBox').classList.remove('hidden');
          document.getElementById('userInfoBox2').classList.remove('hidden');
          document.getElementById('loginBtnPage1').style.display = 'none';
          document.getElementById('loginBtnPage2').style.display = 'none';
        } else {
          document.getElementById('userInfoBox').classList.add('hidden');
          document.getElementById('userInfoBox2').classList.add('hidden');
          document.getElementById('loginBtnPage1').style.display = 'inline-block';
          document.getElementById('loginBtnPage2').style.display = 'inline-block';
        }
      }

      // Inicialización
      initChatWidget();
      updateAllUserInfo();
      
      // Mostrar página 1 si hay usuario logueado, login si no
      const user = localStorage.getItem('user');
      if (user) {
        goToPage('page1');
      }
    }

    // Cargar templates al iniciar
    loadTemplates();
  </script>
</body>
</html>