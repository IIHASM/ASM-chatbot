<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Suggero Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="templates/styles.css" />
  <link rel="stylesheet" href="templates/login.css" />
  <link rel="stylesheet" href="templates/pages.css" />
</head>
<body>
  <!-- Language Switcher -->
  <div class="language-switcher">
    <button onclick="changeLanguage('es')" id="lang-es" class="active">ES</button>
    <button onclick="changeLanguage('ca')" id="lang-ca">CAT</button>
  </div>

  <div id="app-container"></div>

  <!-- Contenedor del widget -->
  <div id="chat-widget"></div>

  <!-- Bundle IIFE -->
  <script src="/dist/chat-widget.standalone.iife.js"></script>

  <script type="module">
    // Sistema de traducciones
    const translations = {
      es: {
        // Login
        loginTitle: 'Iniciar Sesión',
        email: 'Email:',
        password: 'Contraseña:',
        loginButton: 'Iniciar Sesión',
        continueWithout: 'Continuar sin sesión',
        errorLogin: 'Email o contraseña incorrectos',
        
        // User info
        connectedAs: 'Conectado como:',
        logout: 'Cerrar Sesión',
        login: 'Iniciar Sesión',
        
        // Page 1
        page1Title: 'Página 1 - Entorno de pruebas de Suggero Assistant',
        page1Text1: 'Esta es la primera página de prueba del asistente.',
        page1Text2: 'Puedes escribir un mensaje y luego ir a la página 2 para verificar que el historial se mantiene.',
        goToPage2: 'Ir a Página 2 →',
        
        // Page 2
        page2Title: 'Página 2 - Entorno de pruebas de Suggero Assistant',
        page2Text1: 'Esta es la segunda página de prueba del asistente.',
        page2Text2: 'El chat mantiene su estado y el historial de conversación.',
        page2Text3: 'Puedes volver a la página 1 usando el botón de abajo.',
        goToPage1: '← Volver a Página 1'
      },
      ca: {
        // Login
        loginTitle: 'Iniciar Sessió',
        email: 'Correu electrònic:',
        password: 'Contrasenya:',
        loginButton: 'Iniciar Sessió',
        continueWithout: 'Continuar sense sessió',
        errorLogin: 'Correu o contrasenya incorrectes',
        
        // User info
        connectedAs: 'Connectat com:',
        logout: 'Tancar Sessió',
        login: 'Iniciar Sessió',
        
        // Page 1
        page1Title: 'Pàgina 1 - Entorn de proves de Suggero Assistant',
        page1Text1: 'Aquesta és la primera pàgina de prova de l\'assistent.',
        page1Text2: 'Pots escriure un missatge i després anar a la pàgina 2 per verificar que l\'historial es manté.',
        goToPage2: 'Anar a Pàgina 2 →',
        
        // Page 2
        page2Title: 'Pàgina 2 - Entorn de proves de Suggero Assistant',
        page2Text1: 'Aquesta és la segona pàgina de prova de l\'assistent.',
        page2Text2: 'El xat manté el seu estat i l\'historial de conversa.',
        page2Text3: 'Pots tornar a la pàgina 1 fent servir el botó de sota.',
        goToPage1: '← Tornar a Pàgina 1'
      }
    };

    let currentLanguage = localStorage.getItem('language') || 'es';

    // Función para cambiar idioma
    window.changeLanguage = function(lang) {
      localStorage.setItem('language', lang);
      currentLanguage = lang;
      updateTexts();
      // No recargues la página, solo actualiza los textos
    };

    // Al cargar la página, marcar el botón activo
    document.addEventListener('DOMContentLoaded', () => {
      const lang = localStorage.getItem('language') || 'es';
      document.querySelectorAll('.language-switcher button').forEach(btn => {
        btn.classList.remove('active');
      });
      const activeBtn = document.getElementById('lang-' + lang);
      if (activeBtn) activeBtn.classList.add('active');
    });

    // Función para actualizar todos los textos
    function updateTexts() {
      const t = translations[currentLanguage];
      
      // Login
      document.querySelector('#loginPage h2').textContent = t.loginTitle;
      document.querySelector('label[for="email"]').textContent = t.email;
      document.querySelector('label[for="password"]').textContent = t.password;
      document.querySelector('#loginPage .login-button').textContent = t.loginButton;
      document.querySelector('#loginPage .back-link').textContent = t.continueWithout;
      
      // User info
      document.querySelectorAll('.user-info > div:first-child').forEach(el => {
        const userName = el.querySelector('strong')?.textContent || '';
        el.innerHTML = `${t.connectedAs} <strong>${userName}</strong>`;
      });
      document.querySelectorAll('.logout-button').forEach(el => {
        el.textContent = t.logout;
      });
      document.querySelectorAll('.session-button').forEach(el => {
        el.textContent = t.login;
      });
      
      // Page 1
      document.querySelector('#page1 h1').textContent = t.page1Title;
      const page1Paragraphs = document.querySelectorAll('#page1 p');
      page1Paragraphs[0].textContent = t.page1Text1;
      page1Paragraphs[1].textContent = t.page1Text2;
      document.querySelector('#page1 .nav-button').textContent = t.goToPage2;
      
      // Page 2
      document.querySelector('#page2 h1').textContent = t.page2Title;
      const page2Paragraphs = document.querySelectorAll('#page2 p');
      page2Paragraphs[0].textContent = t.page2Text1;
      page2Paragraphs[1].textContent = t.page2Text2;
      page2Paragraphs[2].textContent = t.page2Text3;
      document.querySelector('#page2 .nav-button').textContent = t.goToPage1;
    }

    // Cargar templates
    async function loadTemplates() {
      try {
        const loginHtml = await fetch('templates/login.html').then(r => r.text());
        const page1Html = await fetch('templates/page1.html').then(r => r.text());
        const page2Html = await fetch('templates/page2.html').then(r => r.text());
        
        document.getElementById('app-container').innerHTML = loginHtml + page1Html + page2Html;
        
        initializeApp();
      } catch (error) {
        console.error('Error loading templates:', error);
      }
    }

    function initializeApp() {
      // Función de navegación entre páginas
      window.goToPage = function(pageId) {
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');
        updateAllUserInfo();
      }

      // Función de login
      window.handleLogin = function(event) {
        event.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorMessage = document.getElementById('errorMessage');

        if (email === 'ivan.izquierdo@asm.com' && password === 'prueba123') {
          localStorage.setItem('user', JSON.stringify({ email, name: 'Iván' }));
          
          document.getElementById('email').value = '';
          document.getElementById('password').value = '';
          errorMessage.classList.remove('show');

          updateAllUserInfo();
          initChatWidget();
          goToPage('page1');
          location.reload(); 
        } else {
          errorMessage.textContent = translations[currentLanguage].errorLogin;
          errorMessage.classList.add('show');
        }
      }

      // Función de logout
      window.handleLogout = function() {
        localStorage.removeItem('user');
        updateAllUserInfo();
        goToPage('loginPage');
        location.reload();
      }

      // Actualizar información del usuario
      function updateAllUserInfo() {
        const user = localStorage.getItem('user');

        if (user) {
          const userData = JSON.parse(user);

          const el1 = document.getElementById('userName');
          const el2 = document.getElementById('userName2');
          const box1 = document.getElementById('userInfoBox');
          const box2 = document.getElementById('userInfoBox2');
          const btn1 = document.getElementById('loginBtnPage1');
          const btn2 = document.getElementById('loginBtnPage2');

          if (el1) el1.textContent = userData.name;
          if (el2) el2.textContent = userData.name;
          if (box1) box1.classList.remove('hidden');
          if (box2) box2.classList.remove('hidden');
          if (btn1) btn1.style.display = 'none';
          if (btn2) btn2.style.display = 'none';
        } else {
          const box1 = document.getElementById('userInfoBox');
          const box2 = document.getElementById('userInfoBox2');
          const btn1 = document.getElementById('loginBtnPage1');
          const btn2 = document.getElementById('loginBtnPage2');

          if (box1) box1.classList.add('hidden');
          if (box2) box2.classList.add('hidden');
          if (btn1) btn1.style.display = 'inline-block';
          if (btn2) btn2.style.display = 'inline-block';
        }

        updateTexts();
      }

      // Inicializar el widget usando IIFE
      function initChatWidget() {
        const user = JSON.parse(localStorage.getItem('user'));
        const userName = user?.name;

        window.CHAT_WIDGET_CONFIG = { userName };

        ChatWidget.init({
          target: '#chat-widget',
          styleApiUrl: 'https://assistant.suggero.io/chatbot-feature/7',
          project: 'dyv',
          backend: 'http://localhost:3000'
        });
      }

      updateAllUserInfo();
      initChatWidget();

      const user = localStorage.getItem('user');
      if (user) {
        goToPage('page1');
      }
    }

    loadTemplates();
  </script>
</body>
</html>